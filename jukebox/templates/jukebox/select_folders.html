{% extends "jukebox/base.html" %}
<!-- vim: tabstop=8 expandtab shiftwidth=4 softtabstop=4 
-->

{% block title %}Hack Radio{% endblock %}   

{% block content %}

<div>

  <p>&nbsp;</p>

        <table id="tree" data-path="">
            <thead>
            <tr><th>Folder path</th></tr>
            </thead>
            <tbody>
                <!-- filled by AJAX -->
            </tbody>
        </table>


</div>

<!-- Modal dialogs -->

<div id="convert_modal" class="modal" tabindex="-1" role="dialog">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Converting files to mp3...</h4>
      </div>
      <div class="modal-body">
      <!-- filled by Ajax -->
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-default" data-dismiss="modal">Close</button>
      </div>
    </div><!-- /.modal-content -->
  </div><!-- /.modal-dialog -->
</div><!-- /.modal -->

<!-- Templates -->

{% verbatim %}
<script id="modal-body-template" type="text/x-jsrender">
    <div class="panel panel-default">
        <div class="panel-heading">Now converting</div>
        <div class="panel-body">
            {{for running}}
                <p>{{:filename}}</p>
            {{/for}}
        </div>
    </div>
    <div class="panel panel-default">
        <div class="panel-heading">Queued</div>
        <div class="panel-body">
            {{for queued}}
                <p>{{:filename}}</p>
            {{/for}}
        </div>
    </div>
</script>

<script id="root-folder-template" type="text/x-jsrender">
<tr class="root_folder" data-tt-id="{{:id}}" data-tt-branch="true">
  <td><span class="folder">{{:name}}</span></td>
</tr>
</script>

<script id="folder-template" type="text/x-jsrender">
<tr data-tt-id="{{:id}}" data-tt-parent-id="{{:parent}}" 
  {{if has_children}}data-tt-branch="true"{{/if}}
  {{if selected}}class="bg-info"{{/if}}>
<td>
{{if selectable}}
<span class="label label-info songs_button" data-folderid="{{:id}}" 
      data-container="body"
      data-toggle="popover" data-trigger="hover" 
      title="Songs in {{:name}}" data-html="true" 
      data-content="To be Filled In">Songs</span>
&nbsp;&nbsp;
{{/if}}
<span class="folder">{{:name}}</span></td> 
</tr>
</script>

<script id="popover-template" type="text/x-jsrender">
    {{for songs}}
       {{:filename}}<br />
    {{/for}}
</script>
{% endverbatim %}

<script type="text/javascript">

function update_convert_queue() {
    $.get(Urls['jukebox:convert_status'](), function(data){
        html = $("#modal-body-template").render(data);
        $(".modal-body").html(html);

        if (data.running.length == 0 && data.queued.length == 0) {
            $('#convert_modal').modal('hide')
            clearInterval(convert_queue_interval);
        }
    });
}

function toggle_folder(event) {
    folderid = $(this).parent().parent().attr('data-tt-id');
    //alert("Selecting folder " + folderid);
    $.get(Urls['jukebox:toggle_folder'](folderid), function(data){
        row = $("tr[data-tt-id="+folderid+"]");
        if (data.selected) {
            row.addClass("bg-info");
            if (data.converting) {
                $('#convert_modal').modal('show')
                update_convert_queue();
                convert_queue_interval = setInterval(update_convert_queue, 1000);
            }
        } else {
            row.removeClass("bg-info");
        }
    });
}

function fill_song_popover(folderid) {
    $.get(Urls['jukebox:folder_songs'](folderid), function(data){
        button = $(".songs_button[data-folderid='" + folderid + "']");
        html = $("#popover-template").render(data);
        button.attr('data-content', html);
    });
}

function update_roots() {
    $.get("{% url 'jukebox:json_roots' %}", function(data){
        $("tr.root_folder").each(function(index,item) {
            id = $(this).attr("data-tt-id");
            table.treetable("removeNode", id);
        });

        html = $("#root-folder-template").render(data.roots);
        table = $("table#tree");
        table.treetable("loadBranch", null, html);
    });
}

function load_children(root) {
    root_id = root.id;
    $.get(Urls['jukebox:folder_subdirs'](root_id), function(data){
        table = $("#tree");
        html = $("#folder-template").render(data.children);
        table.treetable("loadBranch", root, html);
        $.each(data.children, function(i, item) {
            fill_song_popover(item.id);
        });
        $('span.songs_button[data-toggle="popover"]').popover();
    });
}

$(document).ready( function() {
    update_roots();

    var table = $("#tree");

    table.treetable({
        expandable: true,
        initialState: "collapsed",
        onNodeCollapse: function() {
            var node = this;
            table.treetable("unloadBranch", node);
        },
        onNodeExpand: function() {
            var node = this;
            load_children(node);
        }
    });

    $(document).on("mousedown", "span.folder", toggle_folder);
});
</script>
{% endblock %}   
